// Script corregido para identificar y solucionar el problema de sesi√≥n
console.log('üîß SOLUCI√ìN DIRECTA V2 - PROBLEMA DE SESI√ìN');
console.log('============================================');

// Funci√≥n para obtener Supabase desde el contexto de React
function getSupabase() {
  // Intentar diferentes formas de acceder a Supabase
  if (window.supabase) {
    return window.supabase;
  }
  
  // Buscar en el contexto de React
  const reactRoot = document.querySelector('#__next') || document.querySelector('#root');
  if (reactRoot && reactRoot._reactInternalFiber) {
    // Intentar acceder a trav√©s del contexto de React
    try {
      const fiber = reactRoot._reactInternalFiber;
      if (fiber.memoizedState && fiber.memoizedState.element) {
        // Buscar en el contexto
        return null; // Fallback
      }
    } catch (e) {
      console.log('No se pudo acceder al contexto de React');
    }
  }
  
  return null;
}

// Funci√≥n para verificar el estado actual
async function checkCurrentState() {
  console.log('üîç Verificando estado actual...');
  
  // Verificar si estamos en la p√°gina de booking
  const isBookingPage = window.location.pathname.includes('/booking/');
  console.log('üìç P√°gina actual:', window.location.pathname, isBookingPage ? '(‚úÖ P√°gina de booking)' : '(‚ùå No es p√°gina de booking)');
  
  // Verificar si hay formulario
  const form = document.querySelector('form');
  console.log('üìù Formulario encontrado:', !!form);
  
  // Verificar si hay bot√≥n de env√≠o
  const submitButton = document.querySelector('button[type="submit"]');
  console.log('üîò Bot√≥n de env√≠o encontrado:', !!submitButton);
  
  // Verificar sesi√≥n usando fetch directo
  try {
    console.log('üîê Verificando sesi√≥n con fetch...');
    const response = await fetch('/api/auth/session', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      }
    });
    
    if (response.ok) {
      const sessionData = await response.json();
      console.log('‚úÖ Sesi√≥n verificada con fetch:', {
        hasSession: !!sessionData.session,
        hasUser: !!sessionData.session?.user,
        userId: sessionData.session?.user?.id
      });
    } else {
      console.log('‚ö†Ô∏è No se pudo verificar sesi√≥n con fetch');
    }
  } catch (error) {
    console.log('‚ö†Ô∏è Error al verificar sesi√≥n con fetch:', error.message);
  }
  
  return { isBookingPage, hasForm: !!form, hasSubmitButton: !!submitButton };
}

// Funci√≥n para interceptar el env√≠o del formulario
function interceptFormSubmission() {
  console.log('üîÑ Interceptando env√≠o del formulario...');
  
  const form = document.querySelector('form');
  if (!form) {
    console.error('‚ùå No se encontr√≥ el formulario');
    return;
  }
  
  // Interceptar el evento submit del formulario
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    console.log('üö® FORMULARIO INTERCEPTADO - Verificando sesi√≥n...');
    
    try {
      // Verificar sesi√≥n antes del env√≠o
      const response = await fetch('/api/auth/session', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        }
      });
      
      if (response.ok) {
        const sessionData = await response.json();
        console.log('üîê Estado de sesi√≥n en submit:', {
          hasSession: !!sessionData.session,
          hasUser: !!sessionData.session?.user,
          userId: sessionData.session?.user?.id
        });
        
        if (!sessionData.session?.access_token) {
          console.error('‚ùå PROBLEMA IDENTIFICADO: No hay token de acceso en el submit');
          alert('‚ùå PROBLEMA IDENTIFICADO: La sesi√≥n se perdi√≥ antes del env√≠o del formulario');
          return;
        }
        
        console.log('‚úÖ Sesi√≥n v√°lida, procediendo con env√≠o...');
        // Continuar con el env√≠o original
        form.submit();
      } else {
        console.error('‚ùå No se pudo verificar sesi√≥n');
        alert('‚ùå Error al verificar sesi√≥n');
      }
    } catch (error) {
      console.error('‚ùå Error al verificar sesi√≥n en submit:', error);
      alert('‚ùå Error al verificar sesi√≥n: ' + error.message);
    }
  });
  
  console.log('‚úÖ Interceptaci√≥n del formulario configurada');
}

// Funci√≥n para crear bot√≥n de soluci√≥n directa
function createDirectSolutionButton() {
  console.log('üîß Creando bot√≥n de soluci√≥n directa...');
  
  const solutionButton = document.createElement('button');
  solutionButton.textContent = 'üîß Soluci√≥n Directa V2';
  solutionButton.style.cssText = `
    position: fixed;
    top: 740px;
    right: 20px;
    z-index: 10000;
    background: #dc2626;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
  `;
  
  solutionButton.onclick = async () => {
    console.log('üîß Aplicando soluci√≥n directa V2...');
    
    try {
      // Verificar estado actual
      const state = await checkCurrentState();
      
      if (!state.isBookingPage) {
        alert('‚ùå No est√°s en la p√°gina de booking');
        return;
      }
      
      if (!state.hasForm) {
        alert('‚ùå No se encontr√≥ el formulario');
        return;
      }
      
      // Obtener sesi√≥n usando fetch
      console.log('üîê Obteniendo sesi√≥n...');
      const sessionResponse = await fetch('/api/auth/session', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        }
      });
      
      if (!sessionResponse.ok) {
        alert('‚ùå No se pudo obtener la sesi√≥n. Por favor, inicia sesi√≥n.');
        return;
      }
      
      const sessionData = await sessionResponse.json();
      
      if (!sessionData.session?.access_token) {
        alert('‚ùå No hay sesi√≥n activa. Por favor, inicia sesi√≥n.');
        return;
      }
      
      console.log('‚úÖ Sesi√≥n v√°lida obtenida');
      
      // Crear datos de prueba
      const testData = {
        user_id: sessionData.session.user.id,
        service_id: '08ae78c2-5622-404a-81ae-1a6dbd4ebdea',
        reservation_date: '2025-07-25',
        reservation_time: '12:00',
        guests: 1,
        total_amount: 90,
        status: "pendiente",
        payment_status: "pendiente",
        special_requests: null,
        contact_name: 'Test User',
        contact_email: 'test@example.com',
        contact_phone: '123456789',
      };
      
      console.log('üì§ Creando reserva...');
      
      // Crear reserva
      const reservationResponse = await fetch('/api/reservations', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${sessionData.session.access_token}`,
        },
        body: JSON.stringify(testData)
      });
      
      if (!reservationResponse.ok) {
        const error = await reservationResponse.json();
        alert(`‚ùå Error al crear reserva: ${error.error || 'Error desconocido'}`);
        return;
      }
      
      const reservation = await reservationResponse.json();
      console.log('‚úÖ Reserva creada:', reservation.id);
      
      // Verificar sesi√≥n despu√©s de crear reserva
      const sessionAfterReservation = await fetch('/api/auth/session', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        }
      });
      
      if (sessionAfterReservation.ok) {
        const sessionAfterData = await sessionAfterReservation.json();
        console.log('üîê Sesi√≥n despu√©s de reserva:', {
          hasSession: !!sessionAfterData.session,
          hasToken: !!sessionAfterData.session?.access_token
        });
      }
      
      console.log('üí≥ Creando pago...');
      
      // Crear pago
      const paymentResponse = await fetch('/api/payment/create', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${sessionData.session.access_token}`,
        },
        body: JSON.stringify({
          reservationId: reservation.id,
          amount: 90,
          description: 'Reserva: Glamping'
        })
      });
      
      if (!paymentResponse.ok) {
        const error = await paymentResponse.json();
        alert(`‚ùå Error al crear pago: ${error.error || 'Error desconocido'}`);
        return;
      }
      
      const paymentData = await paymentResponse.json();
      console.log('‚úÖ Pago creado');
      
      // Verificar sesi√≥n despu√©s de crear pago
      const sessionAfterPayment = await fetch('/api/auth/session', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        }
      });
      
      if (sessionAfterPayment.ok) {
        const sessionAfterPaymentData = await sessionAfterPayment.json();
        console.log('üîê Sesi√≥n despu√©s de pago:', {
          hasSession: !!sessionAfterPaymentData.session,
          hasToken: !!sessionAfterPaymentData.session?.access_token
        });
      }
      
      // Crear formulario con verificaci√≥n de sesi√≥n
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = paymentData.redsysUrl;
      
      Object.entries(paymentData.formData).forEach(([key, value]) => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = value;
        form.appendChild(input);
      });
      
      document.body.appendChild(form);
      
      // Verificaci√≥n final de sesi√≥n antes del env√≠o
      const finalSessionCheck = await fetch('/api/auth/session', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        }
      });
      
      if (finalSessionCheck.ok) {
        const finalSessionData = await finalSessionCheck.json();
        
        if (!finalSessionData.session?.access_token) {
          console.error('‚ùå PROBLEMA CR√çTICO: Sesi√≥n perdida antes del env√≠o final');
          alert('‚ùå PROBLEMA CR√çTICO: La sesi√≥n se perdi√≥ antes del env√≠o final. Esto explica por qu√© no funciona.');
          return;
        }
        
        console.log('‚úÖ Sesi√≥n v√°lida antes del env√≠o final');
      }
      
      const confirmed = confirm(`¬øProceder con el env√≠o?\n\nImporte: 90‚Ç¨\nServicio: Glamping\n\nLa sesi√≥n est√° verificada y deber√≠a funcionar.`);
      
      if (confirmed) {
        console.log('üöÄ Enviando formulario con sesi√≥n verificada...');
        form.submit();
      }
      
    } catch (error) {
      console.error('‚ùå Error en soluci√≥n directa V2:', error);
      alert(`Error: ${error.message}`);
    }
  };
  
  document.body.appendChild(solutionButton);
  console.log('‚úÖ Bot√≥n de soluci√≥n directa V2 creado');
}

// Funci√≥n para crear bot√≥n de diagn√≥stico de sesi√≥n
function createSessionDiagnosticButton() {
  console.log('üîç Creando bot√≥n de diagn√≥stico de sesi√≥n...');
  
  const diagnosticButton = document.createElement('button');
  diagnosticButton.textContent = 'üîç Diagn√≥stico Sesi√≥n V2';
  diagnosticButton.style.cssText = `
    position: fixed;
    top: 780px;
    right: 20px;
    z-index: 10000;
    background: #f59e0b;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
  `;
  
  diagnosticButton.onclick = async () => {
    console.log('üîç Ejecutando diagn√≥stico de sesi√≥n V2...');
    
    await checkCurrentState();
    interceptFormSubmission();
    
    alert('‚úÖ Diagn√≥stico V2 aplicado. Ahora intenta usar el formulario normal y veremos d√≥nde se rompe la sesi√≥n.');
  };
  
  document.body.appendChild(diagnosticButton);
  console.log('‚úÖ Bot√≥n de diagn√≥stico de sesi√≥n V2 creado');
}

// Funci√≥n para crear bot√≥n de prueba simple
function createSimpleTestButton() {
  console.log('üß™ Creando bot√≥n de prueba simple...');
  
  const testButton = document.createElement('button');
  testButton.textContent = 'üß™ Prueba Simple';
  testButton.style.cssText = `
    position: fixed;
    top: 820px;
    right: 20px;
    z-index: 10000;
    background: #059669;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
  `;
  
  testButton.onclick = async () => {
    console.log('üß™ Ejecutando prueba simple...');
    
    try {
      // Verificar si hay sesi√≥n
      const response = await fetch('/api/auth/session', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        }
      });
      
      if (response.ok) {
        const sessionData = await response.json();
        console.log('üîê Datos de sesi√≥n:', sessionData);
        
        if (sessionData.session?.access_token) {
          alert('‚úÖ Sesi√≥n v√°lida encontrada');
        } else {
          alert('‚ùå No hay sesi√≥n activa');
        }
      } else {
        alert('‚ùå Error al verificar sesi√≥n');
      }
    } catch (error) {
      console.error('‚ùå Error en prueba simple:', error);
      alert(`Error: ${error.message}`);
    }
  };
  
  document.body.appendChild(testButton);
  console.log('‚úÖ Bot√≥n de prueba simple creado');
}

// Ejecutar funciones
createDirectSolutionButton();
createSessionDiagnosticButton();
createSimpleTestButton();

console.log('üéâ Script de soluci√≥n directa V2 completado');
console.log('üí° Usa el bot√≥n rojo para soluci√≥n directa, el naranja para diagn√≥stico, o el verde para prueba simple'); 